#!/bin/bash
# The logic to start up your application should be put in this
# script. The application will work only if it binds to
# $OPENSHIFT_DIY_IP:8080
#nohup $OPENSHIFT_REPO_DIR/diy/testrubyserver.rb $OPENSHIFT_DIY_IP $OPENSHIFT_REPO_DIR/diy |& /usr/bin/logshifter -tag diy &
set -e

: '
# Prepare the runtime
[ -d $OPENSHIFT_DATA_DIR/go ] ||
    curl https://storage.googleapis.com/golang/go1.5.1.linux-amd64.tar.gz |
    tar -xzf - -C $OPENSHIFT_DATA_DIR
#curl https://github.com/gogits/gogs/releases/download/v0.6.9/linux_amd64.zip | tar -xf - -C $OPENSHIFT_DATA_DIR
if [ ! -d $OPENSHIFT_DATA_DIR/gogs ]; 
then
    cd $OPENSHIFT_DATA_DIR  
    wget https://github.com/gogits/gogs/releases/download/v0.6.9/linux_amd64.zip -O temp.zip; unzip temp.zip; rm temp.zip
    cd gogs
    mkdir conf
    wget https://raw.githubusercontent.com/gogits/gogs/master/conf/app.ini -O conf/app.ini
    echo "edit it after"
    cd ..
fi
export GOROOT=$OPENSHIFT_DATA_DIR/go
export PATH=$PATH:$GOROOT/bin
cd $OPENSHIFT_DATA_DIR/gogs
#kill -9 `ps aux | grep 'gogs' | grep -v grep | awk '{print $2}'` >/dev/null 2>&1 || true
#echo $LOGNAME,$USER
#su $OPENSHIFT_DATA_DIR|cut -d "/" -f 5
echo $OPENSHIFT_GEAR_UUID
export HOME=$OPENSHIFT_DATA_DIR
cd $HOME/gogs
HOME=$OPENSHIFT_DATA_DIR nohup $OPENSHIFT_DATA_DIR/gogs/gogs web -c $OPENSHIFT_DATA_DIR/gogs/conf/app.ini>>$OPENSHIFT_DATA_DIR/gogs/err.log & echo $! > $OPENSHIFT_DATA_DIR/gogs/run.pid 
exit
#nohup $OPENSHIFT_DATA_DIR/gogs/gogs web -c $OPENSHIFT_DATA_DIR/gogs/conf/app.ini>>err.log 2>&1 &

#cd $OPENSHIFT_DATA_DIR
#pwd
#cd hello
#go build
'
#edit in 
#cd $OPENSHIFT_DATA_DIR/gocode/src/github.com/gogits/gogs/
export GOROOT=$OPENSHIFT_DATA_DIR/go
export PATH=$PATH:$GOROOT/bin
export GOPATH=$OPENSHIFT_DATA_DIR/gocode
#mkdir -p $GOPATH/src/github.com/gogits
cd $GOPATH/src/github.com/gogits
#git clone -b develop https://github.com/gogits/gogs
cd gogs
#go get -u -v ./...
go get -u -tags "sqlite redis memecache" github.com/gogits/gogs
#go build
go build -tags "sqlite redis memecache"
#mkdir -p custom/conf
#cp $OPENSHIFT_DATA_DIR/gogs/conf/app.ini custom/conf/app.ini
export HOME=$OPENSHIFT_DATA_DIR
nohup ./gogs web >>$OPENSHIFT_DATA_DIR/gogs/err.log & echo $! > $OPENSHIFT_DATA_DIR/gogs/run.pid
echo 'done'
exit

